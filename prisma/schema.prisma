// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  owner
  coach
  athlete
}

enum EventOccurrenceStatus {
  scheduled
  canceled
}

enum RSVPStatus {
  going
  not_going
}

enum ChannelType {
  global
  dm
  group
}

model User {
  id                String   @id @default(uuid())
  email             String   @unique
  name              String?
  phone             String?
  address           String?
  role              UserRole
  gymId             String?
  onboarded         Boolean  @default(false)
  avatarUrl         String?
  pushToken         String?
  notifPreferences  Json?    @default("{}")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  gym               Gym?            @relation(fields: [gymId], references: [id])
  createdGym        Gym?             @relation("GymOwner")
  rsvps             RSVP[]
  invitations       Invitation[]
  sentMessages      Message[]        @relation("MessageSender")
  announcements     Announcement[]

  @@index([gymId])
  @@index([email])
}

model Gym {
  id        String   @id @default(uuid())
  name      String
  logoUrl   String?
  createdById String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner     User            @relation("GymOwner", fields: [createdById], references: [id])
  members   User[]
  events    Event[]
  channels  Channel[]
  announcements Announcement[]
  invitations Invitation[]

  @@index([createdById])
}

model Event {
  id             String   @id @default(uuid())
  gymId          String
  title          String
  recurrenceRule String?  // RRULE format
  startTime     String   // Time of day (HH:mm)
  endTime       String   // Time of day (HH:mm)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  gym            Gym              @relation(fields: [gymId], references: [id])
  occurrences    EventOccurrence[]

  @@index([gymId])
}

model EventOccurrence {
  id        String               @id @default(uuid())
  eventId   String
  date      DateTime
  status    EventOccurrenceStatus @default(scheduled)
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  event     Event @relation(fields: [eventId], references: [id])
  rsvps     RSVP[]

  @@index([eventId])
  @@index([date])
  @@unique([eventId, date])
}

model RSVP {
  id        String     @id @default(uuid())
  userId    String
  occurrenceId String
  status    RSVPStatus @default(going)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  user      User            @relation(fields: [userId], references: [id])
  occurrence EventOccurrence @relation(fields: [occurrenceId], references: [id])

  @@unique([userId, occurrenceId])
  @@index([userId])
  @@index([occurrenceId])
  @@map("RSVP")
}

model Invitation {
  id        String   @id @default(uuid())
  gymId     String
  email     String
  role      UserRole
  token     String   @unique
  invitedById String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  gym       Gym  @relation(fields: [gymId], references: [id])
  invitedBy User @relation(fields: [invitedById], references: [id])

  @@index([token])
  @@index([email])
  @@index([gymId])
}

model Announcement {
  id        String   @id @default(uuid())
  gymId     String
  coachId   String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  gym       Gym  @relation(fields: [gymId], references: [id])
  coach     User @relation(fields: [coachId], references: [id])

  @@index([gymId])
  @@index([coachId])
}

model Channel {
  id        String      @id @default(uuid())
  gymId     String
  name      String
  type      ChannelType
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  gym       Gym      @relation(fields: [gymId], references: [id])
  messages  Message[]

  @@index([gymId])
  @@index([type])
}

model Message {
  id        String   @id @default(uuid())
  gymId     String
  channelId String
  senderId  String
  content   String
  attachmentUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  gym       Gym     @relation(fields: [gymId], references: [id])
  channel   Channel @relation(fields: [channelId], references: [id])
  sender    User    @relation("MessageSender", fields: [senderId], references: [id])

  @@index([gymId])
  @@index([channelId])
  @@index([senderId])
  @@index([createdAt])
}
